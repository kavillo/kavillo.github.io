<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Generator</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EY2YJ4KGED"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EY2YJ4KGED');
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas for JPG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom scrollbar for raw data area */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #1e293b; }
        textarea::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Spreadsheet Grid Styles */
        .sheet-grid {
            display: grid;
            gap: 1px;
            background-color: #334155; /* Grid line color */
            border: 1px solid #334155;
            overflow: auto;
            align-content: start;
        }
        .sheet-cell {
            background-color: #0f172a;
            padding: 0; /* Removed padding from container */
            min-width: 80px;
            height: 32px;
        }
        .sheet-cell input {
            width: 100%;
            height: 32px;
            background: transparent;
            color: #e2e8f0;
            border: none;
            outline: none;
            font-size: 0.8rem;
            padding: 4px 6px; /* Reduced vertical padding */
            line-height: 1.2;
            box-sizing: border-box;
        }
        .sheet-cell input:focus {
            background: #1e293b;
            border-radius: 2px;
        }
        .sheet-header {
            background-color: #1e293b;
            font-weight: 600;
            color: #94a3b8;
            text-align: center;
            height: 32px;
        }
        /* Hide color input default UI */
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        
        /* Toast animation */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;

        // --- Canvas Chart Renderer ---
        const CanvasChart = ({ chartData, chartTitle, canvasRef, colors }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                if (!chartData || !canvasRef.current) return;
                
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                
                // Chart dimensions
                const width = 900;
                const height = 550;
                const padding = { top: 80, right: 40, bottom: 60, left: 40 };
                
                // Set canvas size with device pixel ratio for sharpness
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                ctx.scale(dpr, dpr);
                
                // Background
                ctx.fillStyle = colors.background;
                ctx.fillRect(0, 0, width, height);
                
                // Title
                if (chartTitle) {
                    ctx.fillStyle = colors.title;
                    ctx.font = 'bold 24px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(chartTitle, width / 2, 40);
                }
                
                // Collect all series for legend
                const allSeries = chartData.stacks.flatMap(stack => stack);
                
                // Legend
                const legendY = 65;
                const legendItemWidth = 120;
                const totalLegendWidth = allSeries.length * legendItemWidth;
                let legendX = (width - totalLegendWidth) / 2;
                
                ctx.font = '500 14px Inter, sans-serif';
                allSeries.forEach((series, idx) => {
                    const itemX = legendX + idx * legendItemWidth;
                    
                    // Draw dot
                    ctx.beginPath();
                    ctx.arc(itemX + 7, legendY, 6, 0, Math.PI * 2);
                    ctx.fillStyle = series.color;
                    ctx.fill();
                    
                    // Draw label
                    ctx.fillStyle = colors.legend;
                    ctx.textAlign = 'left';
                    ctx.fillText(series.label, itemX + 20, legendY + 5);
                });
                
                // Chart area
                const chartTop = padding.top + 30;
                const chartBottom = height - padding.bottom;
                const chartLeft = padding.left;
                const chartRight = width - padding.right;
                const chartHeight = chartBottom - chartTop;
                const chartWidth = chartRight - chartLeft;
                
                // Bottom line
                ctx.strokeStyle = '#2d3755';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(chartLeft, chartBottom);
                ctx.lineTo(chartRight, chartBottom);
                ctx.stroke();
                
                // Calculate bar positions
                const numCategories = chartData.categories.length;
                const categoryWidth = chartWidth / numCategories;
                const numStacks = chartData.stacks.length;
                const barWidth = Math.min(45, (categoryWidth - 40) / numStacks);
                const barGap = 12;
                
                // Draw bars for each category
                chartData.categories.forEach((category, catIndex) => {
                    const categoryCenter = chartLeft + categoryWidth * catIndex + categoryWidth / 2;
                    const stacksWidth = numStacks * barWidth + (numStacks - 1) * barGap;
                    const stacksStart = categoryCenter - stacksWidth / 2;
                    
                    // Draw each stack
                    chartData.stacks.forEach((stack, stackIdx) => {
                        const barX = stacksStart + stackIdx * (barWidth + barGap);
                        let currentY = chartBottom;
                        
                        const stackTotal = stack.reduce((sum, series) => sum + series.values[catIndex], 0);
                        
                        // Draw segments from bottom to top
                        stack.forEach((series, segIdx) => {
                            const value = series.values[catIndex];
                            if (value <= 0) return;
                            
                            const barHeight = (value / chartData.maxValue) * chartHeight * 0.8;
                            const isTopSegment = segIdx === stack.length - 1 || 
                                stack.slice(segIdx + 1).every(s => s.values[catIndex] <= 0);
                            
                            // Draw bar segment
                            ctx.fillStyle = series.color;
                            if (isTopSegment) {
                                // Rounded top corners
                                const radius = 6;
                                ctx.beginPath();
                                ctx.moveTo(barX, currentY);
                                ctx.lineTo(barX, currentY - barHeight + radius);
                                ctx.quadraticCurveTo(barX, currentY - barHeight, barX + radius, currentY - barHeight);
                                ctx.lineTo(barX + barWidth - radius, currentY - barHeight);
                                ctx.quadraticCurveTo(barX + barWidth, currentY - barHeight, barX + barWidth, currentY - barHeight + radius);
                                ctx.lineTo(barX + barWidth, currentY);
                                ctx.closePath();
                                ctx.fill();
                            } else {
                                ctx.fillRect(barX, currentY - barHeight, barWidth, barHeight);
                            }
                            
                            // Draw value label inside bar
                            const displayValue = series.displayValues[catIndex];
                            if (displayValue && barHeight > 20) {
                                ctx.fillStyle = colors.barValues;
                                ctx.font = 'bold 12px Inter, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.shadowColor = 'rgba(0,0,0,0.8)';
                                ctx.shadowBlur = 2;
                                ctx.shadowOffsetY = 1;
                                ctx.fillText(displayValue, barX + barWidth / 2, currentY - barHeight / 2 + 4);
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                                ctx.shadowOffsetY = 0;
                            } else if (displayValue && barHeight > 0) {
                                // Small bar - show value above
                                ctx.fillStyle = colors.barValues;
                                ctx.font = 'bold 12px Inter, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.shadowColor = 'rgba(0,0,0,0.8)';
                                ctx.shadowBlur = 2;
                                ctx.fillText(displayValue, barX + barWidth / 2, currentY - barHeight - 8);
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                            }
                            
                            currentY -= barHeight;
                        });
                        
                        // Draw stack total above bar (for stacked bars)
                        if (stack.length > 1 && stackTotal > 0) {
                            const firstDisplay = stack[0].displayValues[catIndex];
                            let formattedTotal = stackTotal.toFixed(1).replace(/\.0$/, '');
                            if (firstDisplay && typeof firstDisplay === 'string') {
                                if (firstDisplay.includes('M')) formattedTotal += 'M';
                                if (firstDisplay.includes('$')) formattedTotal = '$' + formattedTotal;
                                if (firstDisplay.includes('%')) formattedTotal += '%';
                            }
                            
                            ctx.fillStyle = colors.barValues;
                            ctx.font = 'bold 14px Inter, sans-serif';
                            ctx.textAlign = 'center';
                            ctx.fillText(formattedTotal, barX + barWidth / 2, currentY - 12);
                        }
                    });
                    
                    // Category label
                    const isLast = catIndex === numCategories - 1;
                    ctx.fillStyle = isLast ? colors.lastCategory : colors.categoryLabels;
                    ctx.font = '600 16px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(category, categoryCenter, chartBottom + 30);
                });
                
            }, [chartData, chartTitle, colors]);
            
            return (
                <div ref={containerRef} className="flex items-center justify-center">
                    <canvas ref={canvasRef} style={{borderRadius: '12px'}} />
                </div>
            );
        };

        // --- ICONS (SVG Components) ---
        const BarChart3 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
        );
        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const Copy = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        );
        const Code = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
        );
        const LinkIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        );
        const Download = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );
        const Type = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>
        );
        const Palette = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
        );
        const Maximize = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
        );
        const Minimize = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>
        );
        const Table2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>
        );
        const FileText = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
        );
        const Plus = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const HelpCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
        );
        const Undo = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
        );
        const Redo = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/></svg>
        );
        const ChevronUp = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>
        );
        const ChevronDown = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const Clipboard = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>
        );
        const Save = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        );
        const FolderOpen = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg>
        );


        // --- CONSTANTS ---
        const DEFAULT_DATA = `Label,Color,2022,2023,2024,2025
Revenue,#3baef9,14.0,14.1,14.4,14.7
EBITA,#8b95f6,3.1,2.5,1.9,1.1`;

        const THEMES = [
          {
            name: "Default Dark",
                        css: `/* Main Chart Container */
.chart-container {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(to bottom, #111425, #12182e);
    color: white;
    padding: 40px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 500px;
    background-color: #111425;
}
.chart-title { font-size: 1.5rem; font-weight: 700; color: #fff; margin-bottom: 10px; text-align: center; }
.chart-legend { display: flex; gap: 24px; margin-bottom: 40px; margin-top: 10px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #aeb9e1; font-weight: 500; line-height: 1; }
.legend-dot {
    display: block;
    flex-shrink: 0;
    width: 14px;
    height: 14px;
    min-width: 14px;
    min-height: 14px;
    border-radius: 50%;
    box-sizing: border-box;
    margin: 0;
}
.legend-item span { display: inline-block; line-height: 14px; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 1px solid #2d3755; padding-bottom: 10px; padding-left: 20px; padding-right: 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 12px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; justify-content: flex-start; align-items: center; width: 45px; height: 100%; position: relative; margin-bottom: 12px; }
.bar-segment { width: 100%; display: flex; justify-content: center; position: relative; transition: all 0.3s ease; }
/* Label Styling */
.bar-value { position: absolute; font-weight: 700; font-size: 0.8rem; color: #fff; white-space: nowrap; pointer-events: none; }
.bar-total { width: 100%; font-weight: 700; font-size: 0.9rem; color: #fff; white-space: nowrap; text-align: center; position: static !important; margin-bottom: 8px; }
.category-label { margin-top: 20px; font-weight: 600; color: #fff; font-size: 1rem; }`
          },
          {
            name: "Light Professional",
            css: `.chart-container {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  background: #ffffff;
  color: #333333;
  padding: 40px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
  border: 1px solid #e2e8f0;
}
.chart-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; margin-bottom: 20px; }
.chart-legend { display: flex; gap: 24px; margin-bottom: 30px; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #64748b; font-weight: 500; }
.legend-dot { width: 10px; height: 10px; border-radius: 2px; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 2px solid #cbd5e1; padding-bottom: 10px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; border-left: 1px dashed #f1f5f9; padding: 0 15px; }
.category-group:last-child { border-right: 1px dashed #f1f5f9; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 40px; height: 100%; position: relative; }
.bar-segment { width: 100%; transition: all 0.3s ease; }
.bar-segment:hover { filter: brightness(0.95); }
.bar-value { position: absolute; font-weight: 600; font-size: 0.75rem; color: #334155 !important; }
.bar-total { width: 100%; font-weight: 700; font-size: 0.85rem; color: #1e293b; width: 100%; text-align: center; position: static !important; }
.category-label { margin-top: 15px; font-weight: 500; color: #475569 !important; font-size: 0.9rem; }`
          },
          {
            name: "Blueprint",
            css: `.chart-container {
  font-family: 'Courier New', monospace;
  background-color: #1e3a8a;
  background-image: linear-gradient(#2563eb 1px, transparent 1px), linear-gradient(90deg, #2563eb 1px, transparent 1px);
  background-size: 20px 20px;
  color: #bfdbfe;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
}
.chart-title { font-size: 1.8rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid #fff; padding-bottom: 10px; }
.chart-legend { display: flex; gap: 20px; margin-bottom: 40px; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 10px; border: 1px solid #60a5fa; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #fff; }
.legend-dot { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid; background: transparent !important; border-bottom-color: inherit; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 2px solid #fff; border-left: 2px solid #fff; padding: 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 15px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 30px; height: 100%; position: relative; }
.bar-segment { width: 100%; border: 1px solid rgba(255,255,255,0.5); }
.bar-value { position: absolute; font-weight: 700; font-size: 0.7rem; color: #fff !important; background: #1e3a8a; padding: 2px; }
.bar-total { width: 100%; font-weight: 700; font-size: 0.8rem; color: #fff; text-align: center; position: static !important; }
.category-label { margin-top: 15px; font-weight: 700; color: #fff !important; font-size: 0.9rem; letter-spacing: 1px; }`
          },
          {
            name: "Retro Vaporwave",
            css: `.chart-container {
  font-family: 'Verdana', sans-serif;
  background: linear-gradient(135deg, #2d0f45, #5b1a6b);
  color: #ff00ff;
  padding: 40px;
  border-radius: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
  box-shadow: 0 0 20px #ff00ff;
}
.chart-title { font-size: 2rem; font-weight: 900; color: #00ffff; text-shadow: 2px 2px #ff00ff; font-style: italic; letter-spacing: -1px; }
.chart-legend { display: flex; gap: 30px; margin-bottom: 40px; border: 2px solid #00ffff; padding: 10px; background: rgba(0,0,0,0.3); }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #fff; text-transform: uppercase; }
.legend-dot { width: 15px; height: 15px; border-radius: 0; box-shadow: 2px 2px 0px #000; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 4px solid #00ffff; padding-bottom: 10px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 10px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 50px; height: 100%; position: relative; }
.bar-segment { width: 100%; box-shadow: 4px 0px 0px rgba(0,0,0,0.3); clip-path: polygon(0 0, 100% 0, 100% 100%, 0 95%); }
.bar-value { position: absolute; font-weight: 700; font-size: 0.9rem; color: #fff !important; text-shadow: 1px 1px #000; }
.bar-total { width: 100%; font-weight: 700; font-size: 1rem; color: #00ffff; text-align: center; text-shadow: 1px 1px #ff00ff; position: static !important; }
.category-label { margin-top: 25px; font-weight: 700; color: #00ffff !important; font-size: 1.1rem; text-shadow: 2px 2px #ff00ff; }`
          },
          {
            name: "Corporate Slate",
            css: `.chart-container {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #0f172a;
  color: #cbd5e1;
  padding: 50px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
}
.chart-title { font-size: 1.4rem; font-weight: 400; color: #f8fafc; text-transform: uppercase; letter-spacing: 1px; width: 100%; text-align: left; border-bottom: 1px solid #334155; padding-bottom: 20px; }
.chart-legend { display: flex; gap: 24px; margin-bottom: 50px; margin-top: 20px; width: 100%; justify-content: flex-start; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #94a3b8; }
.legend-dot { width: 8px; height: 8px; border-radius: 0; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 350px; border-bottom: 1px solid #334155; padding: 0 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; position: relative; padding: 0 15px; }
.category-group::before { content: ''; position: absolute; bottom: 0; left: 50%; width: 1px; height: 100%; background: #1e293b; z-index: 0; transform: translateX(-50%); }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 20px; height: 100%; width: 100%; z-index: 1; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 35px; height: 100%; position: relative; }
.bar-segment { width: 100%; }
.bar-value { position: absolute; font-weight: 600; font-size: 0.8rem; color: #fff !important; }
.bar-total { width: 100%; font-weight: 600; font-size: 0.8rem; color: #cbd5e1; text-align: center; position: static !important; }
.category-label { margin-top: 20px; font-weight: 500; color: #94a3b8 !important; font-size: 0.85rem; }`
          },
          {
            name: "Soft Pastel",
            css: `.chart-container {
  font-family: 'Quicksand', sans-serif;
  background: #fdf2f8;
  color: #831843;
  padding: 40px;
  border-radius: 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
}
.chart-title { font-size: 1.8rem; font-weight: 700; color: #9d174d; margin-bottom: 10px; }
.chart-legend { display: flex; gap: 15px; margin-bottom: 40px; background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #be185d; }
.legend-dot { width: 15px; height: 15px; border-radius: 50%; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 2px dashed #fbcfe8; padding: 0 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 12px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 40px; height: 100%; position: relative; }
.bar-segment { width: 100%; border-radius: 8px; margin-top: 2px; }
.bar-value { position: absolute; font-weight: 700; font-size: 0.8rem; color: #831843 !important; }
.bar-total { width: 100%; font-weight: 700; font-size: 0.9rem; color: #9d174d; text-align: center; position: static !important; }
.category-label { margin-top: 15px; font-weight: 700; color: #9d174d !important; font-size: 1rem; }`
          },
          {
            name: "High Contrast",
            css: `.chart-container {
  font-family: 'Arial Black', sans-serif;
  background: #000000;
  color: #ffffff;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
}
.chart-title { font-size: 2rem; color: #fff; text-transform: uppercase; border: 4px solid #fff; padding: 10px; margin-bottom: 30px; }
.chart-legend { display: flex; gap: 30px; margin-bottom: 40px; }
.legend-item { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; color: #fff; font-weight: bold; }
.legend-dot { width: 20px; height: 20px; border: 2px solid #fff; border-radius: 0; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 5px solid #fff; padding: 0 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; border-right: 1px dotted #333; padding: 0 15px; }
.category-group:last-child { border-right: none; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 10px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 50px; height: 100%; position: relative; }
.bar-segment { width: 100%; border: 2px solid #fff; }
.bar-value { position: absolute; font-weight: bold; font-size: 1rem; color: #fff !important; background: #000; padding: 2px; z-index: 10; border: 1px solid #fff; }
.bar-total { width: 100%; font-weight: bold; font-size: 1rem; color: #fff; text-align: center; position: static !important; }
.category-label { margin-top: 20px; font-weight: bold; color: #fff !important; font-size: 1.2rem; }`
          },
          {
            name: "Forest",
            css: `.chart-container {
  font-family: 'Georgia', serif;
  background: #14532d;
  color: #dcfce7;
  padding: 40px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
}
.chart-title { font-size: 1.8rem; font-style: italic; color: #f0fdf4; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.chart-legend { display: flex; gap: 24px; margin-bottom: 40px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #bbf7d0; }
.legend-dot { width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 3px solid #166534; padding: 0 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 10px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 40px; height: 100%; position: relative; }
.bar-segment { width: 100%; border: 2px solid #fff; border-radius: 2px; }
.bar-segment:last-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
.bar-value { position: absolute; font-weight: normal; font-size: 0.9rem; color: #fff !important; font-family: sans-serif; }
.bar-total { width: 100%; font-weight: normal; font-size: 1rem; color: #bbf7d0; text-align: center; position: static !important; }
.category-label { margin-top: 15px; font-weight: 500; color: #bbf7d0 !important; font-size: 1rem; }`
          },
          {
            name: "Cyberpunk",
            css: `.chart-container {
  font-family: 'Consolas', monospace;
  background: #050505;
  color: #00ff00;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
  border: 1px solid #333;
}
.chart-title { font-size: 1.5rem; color: #eab308; margin-bottom: 20px; text-transform: uppercase; text-shadow: 0 0 10px #eab308; }
.chart-legend { display: flex; gap: 20px; margin-bottom: 40px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #00ff00; }
.legend-dot { width: 10px; height: 10px; background: transparent !important; border: 2px solid; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border-bottom: 1px solid #333; padding: 0 20px; background: repeating-linear-gradient(0deg, transparent, transparent 19px, #111 20px); }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 30px; height: 100%; position: relative; }
.bar-segment { width: 100%; opacity: 0.8; }
.bar-segment:hover { opacity: 1; box-shadow: 0 0 15px currentColor; }
.bar-value { position: absolute; font-size: 0.8rem; color: #00ff00 !important; text-shadow: 0 0 5px #000; background: rgba(0,0,0,0.8); padding: 2px 4px; }
.bar-total { width: 100%; font-size: 0.9rem; color: #eab308; text-align: center; text-shadow: 0 0 5px #eab308; position: static !important; }
.category-label { margin-top: 15px; color: #eab308 !important; font-size: 0.9rem; }`
          },
          {
            name: "Excel Classic",
            css: `.chart-container {
  font-family: Arial, sans-serif;
  background: #ffffff;
  color: #000000;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 500px;
}
.chart-title { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 15px; }
.chart-legend { display: flex; gap: 15px; margin-bottom: 20px; border: 1px solid #ccc; padding: 5px 15px; background: #f9f9f9; }
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #333; }
.legend-dot { width: 10px; height: 10px; border: 1px solid #666; }
.chart-body { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; height: 400px; border: 1px solid #999; background: repeating-linear-gradient(0deg, #fff, #fff 39px, #eee 40px); padding: 0 20px; }
.category-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; padding: 0 15px; }
.bars-wrapper { display: flex; align-items: flex-end; justify-content: center; gap: 5px; height: 100%; width: 100%; }
.bar-stack { display: flex; flex-direction: column-reverse; width: 25px; height: 100%; position: relative; }
.bar-segment { width: 100%; border: 1px solid rgba(0,0,0,0.2); }
.bar-value { position: absolute; font-size: 0.7rem; color: #000 !important; background: rgba(255,255,255,0.8); }
.bar-total { width: 100%; font-size: 0.8rem; color: #000; text-align: center; position: static !important; }
.category-label { margin-top: 5px; font-size: 0.8rem; color: #333 !important; }`
          }
        ];

        // --- HELPER: Parse CSV (simple) ---
        const parseCSV = (str) => {
            return str.split('\n').map(line => line.split(','));
        };

        // --- HELPER: Array to CSV ---
        const toCSV = (rows) => {
            return rows.map(r => r.join(',')).join('\n');
        };

        // --- HELPER: Convert color name/value to hex ---
        const colorToHex = (color) => {
            if (!color) return '#000000';
            color = color.trim();
            // Already hex
            if (color.startsWith('#')) {
                // Ensure valid hex
                if (/^#[0-9A-Fa-f]{6}$/.test(color)) return color;
                if (/^#[0-9A-Fa-f]{3}$/.test(color)) {
                    // Expand shorthand (#abc -> #aabbcc)
                    return '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
                }
                return '#000000';
            }
            // Use browser to convert color name to hex
            const ctx = document.createElement('canvas').getContext('2d');
            ctx.fillStyle = color;
            const computed = ctx.fillStyle;
            // ctx.fillStyle returns hex for valid colors, or the previous value for invalid
            if (computed.startsWith('#')) return computed;
            return '#000000';
        };

        // --- COMPONENT: Spreadsheet Editor ---
        const SpreadsheetEditor = ({ data, onUpdate, onMoveRow }) => {
            const [rows, setRows] = useState([]);

            useEffect(() => {
                setRows(parseCSV(data));
            }, [data]);

            const handleCellChange = (rIdx, cIdx, value) => {
                const newRows = [...rows];
                newRows[rIdx] = [...newRows[rIdx]];
                newRows[rIdx][cIdx] = value;
                setRows(newRows);
                onUpdate(toCSV(newRows));
            };

            const addRow = () => {
                const colCount = rows[0] ? rows[0].length : 4;
                const newRow = Array(colCount).fill('');
                // Default color for 2nd col
                if(colCount > 1) newRow[1] = '#3baef9';
                
                const newRows = [...rows, newRow];
                setRows(newRows);
                onUpdate(toCSV(newRows));
            };

            const addColumn = () => {
                const newRows = rows.map((row, i) => [...row, i === 0 ? `New Cat` : '0']);
                setRows(newRows);
                onUpdate(toCSV(newRows));
            };

            const removeRow = (idx) => {
                if (rows.length <= 2) return; // Keep at least header + 1 row
                const newRows = rows.filter((_, i) => i !== idx);
                setRows(newRows);
                onUpdate(toCSV(newRows));
            };

            const removeColumn = (idx) => {
                if (rows[0].length <= 3) return; // Keep Label, Color + 1 Value
                const newRows = rows.map(row => row.filter((_, i) => i !== idx));
                setRows(newRows);
                onUpdate(toCSV(newRows));
            };

            if (!rows.length) return null;

            return (
                <div className="flex flex-col h-full gap-2">
                    <div className="flex-1 sheet-grid" style={{ gridTemplateColumns: `repeat(${rows[0].length + 1}, minmax(100px, 1fr))` }}>
                        {/* Headers */}
                        {rows[0].map((header, cIdx) => (
                            <div key={`h-${cIdx}`} className="sheet-cell sheet-header flex justify-between items-center group">
                                <input 
                                    value={header} 
                                    onChange={(e) => handleCellChange(0, cIdx, e.target.value)}
                                    className="font-bold text-center"
                                />
                                {cIdx > 2 && (
                                    <button onClick={() => removeColumn(cIdx)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 p-1">
                                        <X size={12} />
                                    </button>
                                )}
                            </div>
                        ))}
                        <div className="sheet-cell sheet-header flex justify-center items-center cursor-pointer hover:bg-slate-700" onClick={addColumn} title="Add Column">
                            <Plus size={16} />
                        </div>

                        {/* Data Rows */}
                        {rows.slice(1).map((row, rIdx) => (
                            <React.Fragment key={`r-${rIdx}`}>
                                {row.map((cell, cIdx) => (
                                    <div key={`c-${rIdx}-${cIdx}`} className="sheet-cell flex items-center gap-1">
                                        {/* Special handling for Color column (Index 1) */}
                                        {cIdx === 1 && (
                                            <input 
                                                type="color" 
                                                value={colorToHex(cell)} 
                                                onChange={(e) => handleCellChange(rIdx + 1, cIdx, e.target.value)}
                                                className="w-6 h-6 rounded cursor-pointer shrink-0"
                                            />
                                        )}
                                        <input 
                                            value={cell} 
                                            onChange={(e) => handleCellChange(rIdx + 1, cIdx, e.target.value)}
                                            placeholder={cIdx === 0 && rIdx > 0 ? "## for stack" : ""}
                                        />
                                    </div>
                                ))}
                                <div className="sheet-cell flex justify-center items-center gap-1">
                                    <button 
                                        onClick={() => onMoveRow && onMoveRow(rIdx + 1, 'up')} 
                                        disabled={rIdx === 0}
                                        className="text-slate-400 hover:text-white p-0.5 rounded hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed"
                                        title="Move up"
                                    >
                                        <ChevronUp size={12} />
                                    </button>
                                    <button 
                                        onClick={() => onMoveRow && onMoveRow(rIdx + 1, 'down')} 
                                        disabled={rIdx === rows.length - 2}
                                        className="text-slate-400 hover:text-white p-0.5 rounded hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed"
                                        title="Move down"
                                    >
                                        <ChevronDown size={12} />
                                    </button>
                                    <button onClick={() => removeRow(rIdx + 1)} className="text-red-500 hover:text-red-400 p-0.5 rounded hover:bg-slate-800">
                                        <X size={12} />
                                    </button>
                                </div>
                            </React.Fragment>
                        ))}
                    </div>
                    <button onClick={addRow} className="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-sm font-medium flex items-center justify-center gap-2">
                        <Plus size={14} /> Add Row
                    </button>
                </div>
            );
        };

        // --- LocalStorage Keys ---
        const STORAGE_KEYS = {
            rawData: 'chartGenerator_rawData',
            cssCode: 'chartGenerator_cssCode',
            chartTitle: 'chartGenerator_chartTitle',
            isRawMode: 'chartGenerator_isRawMode',
            sheetUrl: 'chartGenerator_sheetUrl',
            colorBackground: 'chartGenerator_colorBackground',
            colorTitle: 'chartGenerator_colorTitle',
            colorLegend: 'chartGenerator_colorLegend',
            colorCategoryLabels: 'chartGenerator_colorCategoryLabels',
            colorLastCategory: 'chartGenerator_colorLastCategory',
            colorBarValues: 'chartGenerator_colorBarValues',
            selectedTheme: 'chartGenerator_selectedTheme',
        };

        // --- Default Chart Colors ---
        const DEFAULT_COLORS = {
            background: '#111425',
            title: '#ffffff',
            legend: '#aeb9e1',
            categoryLabels: '#ffffff',
            lastCategory: '#3baef9',
            barValues: '#ffffff',
        };

        // --- Theme Color Presets ---
        const THEME_COLORS = {
            "Default Dark": {
                background: '#111425',
                title: '#ffffff',
                legend: '#aeb9e1',
                categoryLabels: '#ffffff',
                lastCategory: '#3baef9',
                barValues: '#ffffff',
            },
            "Light Professional": {
                background: '#ffffff',
                title: '#1e293b',
                legend: '#64748b',
                categoryLabels: '#475569',
                lastCategory: '#3b82f6',
                barValues: '#334155',
            },
            "Blueprint": {
                background: '#1e3a8a',
                title: '#ffffff',
                legend: '#ffffff',
                categoryLabels: '#ffffff',
                lastCategory: '#60a5fa',
                barValues: '#ffffff',
            },
            "Retro Vaporwave": {
                background: '#2d0f45',
                title: '#00ffff',
                legend: '#ffffff',
                categoryLabels: '#00ffff',
                lastCategory: '#ff00ff',
                barValues: '#ffffff',
            },
            "Corporate Slate": {
                background: '#0f172a',
                title: '#f8fafc',
                legend: '#94a3b8',
                categoryLabels: '#94a3b8',
                lastCategory: '#3b82f6',
                barValues: '#ffffff',
            },
            "Soft Pastel": {
                background: '#fdf2f8',
                title: '#9d174d',
                legend: '#be185d',
                categoryLabels: '#9d174d',
                lastCategory: '#ec4899',
                barValues: '#831843',
            },
            "High Contrast": {
                background: '#000000',
                title: '#ffffff',
                legend: '#ffffff',
                categoryLabels: '#ffffff',
                lastCategory: '#ffff00',
                barValues: '#ffffff',
            },
            "Forest": {
                background: '#14532d',
                title: '#f0fdf4',
                legend: '#bbf7d0',
                categoryLabels: '#bbf7d0',
                lastCategory: '#4ade80',
                barValues: '#ffffff',
            },
            "Cyberpunk": {
                background: '#050505',
                title: '#eab308',
                legend: '#00ff00',
                categoryLabels: '#eab308',
                lastCategory: '#00ff00',
                barValues: '#00ff00',
            },
            "Excel Classic": {
                background: '#ffffff',
                title: '#333333',
                legend: '#333333',
                categoryLabels: '#333333',
                lastCategory: '#0066cc',
                barValues: '#000000',
            },
        };

        // --- Toast Component ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            
            return (
                <div className={`fixed bottom-6 right-6 ${bgColor} text-white px-6 py-3 rounded-lg shadow-xl z-[100] flex items-center gap-3 animate-fade-in`}>
                    <span>{message}</span>
                    <button onClick={onClose} className="hover:opacity-70">
                        <X size={16} />
                    </button>
                </div>
            );
        };

        // --- Help Modal Component ---
        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div 
                    className="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden shadow-2xl border border-slate-600"
                    onClick={e => e.stopPropagation()}
                >
                    <div className="flex justify-between items-center p-4 border-b border-slate-700">
                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                            <HelpCircle size={20} className="text-blue-400" />
                            Chart Generator Help
                        </h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-white p-1">
                            <X size={20} />
                        </button>
                    </div>
                    <div className="p-6 overflow-y-auto max-h-[calc(80vh-80px)] space-y-6 text-slate-300">
                        <section>
                            <h3 className="text-lg font-semibold text-blue-400 mb-2">Quick Start</h3>
                            <ol className="list-decimal list-inside space-y-1 text-sm">
                                <li>Enter your chart title at the top</li>
                                <li>Edit data in the grid or paste CSV in raw mode</li>
                                <li>Customize colors in the CSS Styling tab</li>
                                <li>Download as JPG or copy to clipboard</li>
                            </ol>
                        </section>
                        <section>
                            <h3 className="text-lg font-semibold text-blue-400 mb-2">Data Format (CSV)</h3>
                            <div className="bg-slate-900 p-3 rounded font-mono text-xs">
                                Label,Color,2022,2023,2024<br/>
                                Revenue,#3baef9,14.0,14.1,14.4<br/>
                                EBITA,#8b95f6,3.1,2.5,1.9
                            </div>
                            <ul className="list-disc list-inside mt-2 text-sm space-y-1">
                                <li><strong>Label:</strong> Series name (use ## prefix for stacked bars)</li>
                                <li><strong>Color:</strong> Hex color code for the bar</li>
                                <li><strong>Values:</strong> One column per category</li>
                            </ul>
                        </section>
                        <section>
                            <h3 className="text-lg font-semibold text-blue-400 mb-2">Google Sheets Import</h3>
                            <ol className="list-decimal list-inside space-y-1 text-sm">
                                <li>Create a Google Sheet with the same format</li>
                                <li>Set sharing to "Anyone with the link can view"</li>
                                <li>Paste the URL and click Fetch</li>
                            </ol>
                        </section>
                        <section>
                            <h3 className="text-lg font-semibold text-blue-400 mb-2">Stacked Bars</h3>
                            <p className="text-sm">To create stacked bars, prefix the label with <code className="bg-slate-700 px-1 rounded">##</code>. 
                            The row will stack on top of the previous bar.</p>
                        </section>
                        <section>
                            <h3 className="text-lg font-semibold text-blue-400 mb-2">Keyboard Shortcuts</h3>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div><kbd className="bg-slate-700 px-2 py-0.5 rounded">/Ctrl + Z</kbd></div>
                                <div>Undo</div>
                                <div><kbd className="bg-slate-700 px-2 py-0.5 rounded">/Ctrl + Shift + Z</kbd></div>
                                <div>Redo</div>
                            </div>
                        </section>
                        <section>
                            <h3 className="text-lg font-semibold text-blue-400 mb-2">Theme Presets</h3>
                            <p className="text-sm">Choose from multiple themes in the CSS Styling tab. Each theme automatically adjusts all chart colors.</p>
                        </section>
                    </div>
                </div>
            </div>
        );

        function App() {
            const [rawData, setRawData] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.rawData);
                return saved !== null ? saved : DEFAULT_DATA;
            });
            const [cssCode, setCssCode] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.cssCode);
                return saved !== null ? saved : THEMES[0].css;
            });
            const [activeTab, setActiveTab] = useState('data');
            const [sheetUrl, setSheetUrl] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.sheetUrl);
                return saved !== null ? saved : '';
            });
            const [chartTitle, setChartTitle] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.chartTitle);
                return saved !== null ? saved : 'Annual Performance';
            });
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [isFullScreen, setIsFullScreen] = useState(false);
            const [isRawMode, setIsRawMode] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.isRawMode);
                return saved !== null ? JSON.parse(saved) : false;
            });
            const [selectedTheme, setSelectedTheme] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEYS.selectedTheme);
                return saved !== null ? saved : 'Default Dark';
            });
            const canvasRef = useRef(null);
            
            // --- Toast State ---
            const [toast, setToast] = useState(null);
            const showToast = useCallback((message, type = 'success') => {
                setToast({ message, type });
            }, []);
            
            // --- Help Modal State ---
            const [showHelp, setShowHelp] = useState(false);
            
            // --- Undo/Redo History ---
            const [dataHistory, setDataHistory] = useState([]);
            const [dataFuture, setDataFuture] = useState([]);
            
            const setRawDataWithHistory = useCallback((newData) => {
                setDataHistory(prev => [...prev.slice(-49), rawData]);
                setDataFuture([]);
                setRawData(newData);
            }, [rawData]);
            
            const handleUndo = useCallback(() => {
                if (dataHistory.length === 0) return;
                const previous = dataHistory[dataHistory.length - 1];
                setDataHistory(prev => prev.slice(0, -1));
                setDataFuture(prev => [rawData, ...prev]);
                setRawData(previous);
                showToast('Undo successful');
            }, [dataHistory, rawData, showToast]);
            
            const handleRedo = useCallback(() => {
                if (dataFuture.length === 0) return;
                const next = dataFuture[0];
                setDataFuture(prev => prev.slice(1));
                setDataHistory(prev => [...prev, rawData]);
                setRawData(next);
                showToast('Redo successful');
            }, [dataFuture, rawData, showToast]);
            
            // Keyboard shortcuts for undo/redo
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            handleRedo();
                        } else {
                            handleUndo();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleUndo, handleRedo]);

            // --- Chart Color States ---
            const [chartColors, setChartColors] = useState(() => {
                return {
                    background: localStorage.getItem(STORAGE_KEYS.colorBackground) || DEFAULT_COLORS.background,
                    title: localStorage.getItem(STORAGE_KEYS.colorTitle) || DEFAULT_COLORS.title,
                    legend: localStorage.getItem(STORAGE_KEYS.colorLegend) || DEFAULT_COLORS.legend,
                    categoryLabels: localStorage.getItem(STORAGE_KEYS.colorCategoryLabels) || DEFAULT_COLORS.categoryLabels,
                    lastCategory: localStorage.getItem(STORAGE_KEYS.colorLastCategory) || DEFAULT_COLORS.lastCategory,
                    barValues: localStorage.getItem(STORAGE_KEYS.colorBarValues) || DEFAULT_COLORS.barValues,
                };
            });

            const updateChartColor = (key, value) => {
                setChartColors(prev => ({ ...prev, [key]: value }));
            };

            // --- Save to LocalStorage on change ---
            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.rawData, rawData);
            }, [rawData]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cssCode, cssCode);
            }, [cssCode]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.chartTitle, chartTitle);
            }, [chartTitle]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.isRawMode, JSON.stringify(isRawMode));
            }, [isRawMode]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.sheetUrl, sheetUrl);
            }, [sheetUrl]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.colorBackground, chartColors.background);
                localStorage.setItem(STORAGE_KEYS.colorTitle, chartColors.title);
                localStorage.setItem(STORAGE_KEYS.colorLegend, chartColors.legend);
                localStorage.setItem(STORAGE_KEYS.colorCategoryLabels, chartColors.categoryLabels);
                localStorage.setItem(STORAGE_KEYS.colorLastCategory, chartColors.lastCategory);
                localStorage.setItem(STORAGE_KEYS.colorBarValues, chartColors.barValues);
            }, [chartColors]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.selectedTheme, selectedTheme);
            }, [selectedTheme]);

            // --- Fetch Logic ---
            const handleSheetFetch = async () => {
                if (!sheetUrl) return;
                setIsLoading(true);
                setErrorMsg('');

                try {
                    const match = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    if (!match || !match[1]) {
                        throw new Error("Invalid Google Sheet URL. Could not find Sheet ID.");
                    }
                    const sheetId = match[1];
                    const exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`; // Changed to CSV
                    
                    const response = await fetch(exportUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch. Status: ${response.status}`);
                    }

                    const text = await response.text();
                    setRawData(text);
                } catch (err) {
                    console.error(err);
                    setErrorMsg(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- Download Logic ---
            const handleDownloadJpg = () => {
                if (!canvasRef.current) {
                    showToast("Chart not ready.", "error");
                    return;
                }
                
                try {
                    const dataUrl = canvasRef.current.toDataURL('image/jpeg', 0.95);
                    const link = document.createElement('a');
                    link.download = `${chartTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'chart'}.jpg`;
                    link.href = dataUrl;
                    link.click();
                    showToast('Chart downloaded successfully!');
                } catch (e) {
                    console.error("Download failed", e);
                    showToast("Failed to generate image.", "error");
                }
            };
            
            // --- Copy to Clipboard Logic ---
            const handleCopyToClipboard = async () => {
                if (!canvasRef.current) {
                    showToast("Chart not ready.", "error");
                    return;
                }
                
                try {
                    const canvas = canvasRef.current;
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    showToast('Chart copied to clipboard!');
                } catch (e) {
                    console.error("Copy failed", e);
                    showToast("Failed to copy to clipboard.", "error");
                }
            };
            
            // --- Move Row Logic ---
            const handleMoveRow = useCallback((rowIndex, direction) => {
                const rows = parseCSV(rawData);
                if (direction === 'up' && rowIndex > 1) {
                    const temp = rows[rowIndex];
                    rows[rowIndex] = rows[rowIndex - 1];
                    rows[rowIndex - 1] = temp;
                } else if (direction === 'down' && rowIndex < rows.length - 1) {
                    const temp = rows[rowIndex];
                    rows[rowIndex] = rows[rowIndex + 1];
                    rows[rowIndex + 1] = temp;
                }
                setRawDataWithHistory(toCSV(rows));
            }, [rawData, setRawDataWithHistory]);
            
            // --- File input ref for loading ---
            const fileInputRef = useRef(null);
            
            // --- Save to JSON File ---
            const handleSaveToFile = () => {
                const projectData = {
                    version: 1,
                    chartTitle,
                    rawData,
                    chartColors,
                    selectedTheme,
                    cssCode,
                };
                const json = JSON.stringify(projectData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                const safeName = chartTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'chart';
                link.download = `${safeName}_${dateStr}_${timeStr}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showToast('Chart saved to file!');
            };
            
            // --- Load from JSON File ---
            const handleLoadFromFile = (event) => {
                const file = event.target.files?.[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.rawData) {
                            setRawDataWithHistory(data.rawData);
                        }
                        if (data.chartTitle) {
                            setChartTitle(data.chartTitle);
                        }
                        if (data.chartColors) {
                            setChartColors(data.chartColors);
                        }
                        if (data.selectedTheme) {
                            setSelectedTheme(data.selectedTheme);
                        }
                        if (data.cssCode) {
                            setCssCode(data.cssCode);
                        }
                        showToast('Chart loaded successfully!');
                    } catch (err) {
                        console.error('Failed to parse JSON:', err);
                        showToast('Failed to load file. Invalid format.', 'error');
                    }
                };
                reader.readAsText(file);
                // Reset file input so same file can be loaded again
                event.target.value = '';
            };

            // --- Parser Logic (Comma Separated) ---
            const chartData = useMemo(() => {
                try {
                    const lines = rawData.trim().split('\n');
                    if (lines.length < 2) return null;

                    const headers = lines[0].split(','); // Split by comma
                    const categories = headers.slice(2);

                    let stacks = []; 
                    
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(','); // Split by comma
                        if (cols.length < 2) continue;

                        let label = cols[0];
                        // Clean CSV quotes if present
                        label = label.replace(/^"|"$/g, '');
                        
                        let color = cols[1];
                        color = color ? color.replace(/^"|"$/g, '') : '#ccc';

                        const values = cols.slice(2).map(v => {
                            if (!v) return 0;
                            const cleanV = v.replace(/^"|"$/g, '');
                            const num = parseFloat(cleanV.replace(/[^0-9.-]/g, ''));
                            return isNaN(num) ? 0 : num;
                        });
                        const displayValues = cols.slice(2).map(v => v ? v.replace(/^"|"$/g, '') : '');

                        const isStacked = label.startsWith('##');
                        if (isStacked) label = label.substring(2);

                        const seriesObj = { label, color, values, displayValues };

                        if (isStacked && stacks.length > 0) {
                            stacks[stacks.length - 1].push(seriesObj);
                        } else {
                            stacks.push([seriesObj]);
                        }
                    }

                    let globalMax = 0;
                    categories.forEach((_, catIndex) => {
                        stacks.forEach(stack => {
                            const stackTotal = stack.reduce((sum, series) => sum + series.values[catIndex], 0);
                            if (stackTotal > globalMax) globalMax = stackTotal;
                        });
                    });

                    return { categories, stacks, maxValue: globalMax };
                } catch (e) {
                    console.error("Parse error", e);
                    return null;
                }
            }, [rawData]);

            // --- Dynamic Style Injection ---
            useEffect(() => {
                const styleId = 'dynamic-chart-styles';
                let styleTag = document.getElementById(styleId);
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = styleId;
                    document.head.appendChild(styleTag);
                }
                styleTag.innerHTML = cssCode;
            }, [cssCode]);

            return (
                <div className="flex flex-col h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
                    
                    {/* Toast Notification */}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Help Modal */}
                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                    
                    {/* Header */}
                    {!isFullScreen && (
                    <header className="bg-slate-800 border-b border-slate-700 p-3 md:p-4 flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-2">
                            <BarChart3 className="text-blue-400" />
                            <h1 className="font-bold text-lg hidden sm:block">Chart Generator</h1>
                        </div>
                        <div className="flex gap-1 md:gap-2">
                            {/* Undo/Redo */}
                            <button 
                                onClick={handleUndo}
                                disabled={dataHistory.length === 0}
                                className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white p-2 md:px-3 md:py-2 rounded-md text-sm font-medium transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
                                title="Undo (Z)"
                            >
                                <Undo size={16} />
                            </button>
                            <button 
                                onClick={handleRedo}
                                disabled={dataFuture.length === 0}
                                className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white p-2 md:px-3 md:py-2 rounded-md text-sm font-medium transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
                                title="Redo (Z)"
                            >
                                <Redo size={16} />
                            </button>
                            <div className="w-px bg-slate-600 mx-1 hidden md:block"></div>
                            {/* Help */}
                            <button 
                                onClick={() => setShowHelp(true)}
                                className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white p-2 md:px-3 md:py-2 rounded-md text-sm font-medium transition-colors"
                                title="Help"
                            >
                                <HelpCircle size={16} />
                            </button>
                            <button 
                                onClick={() => setIsFullScreen(true)}
                                className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white p-2 md:px-4 md:py-2 rounded-md text-sm font-medium transition-colors"
                                title="Full Screen"
                            >
                                <Maximize size={16} /> <span className="hidden md:inline">Full Screen</span>
                            </button>
                            <div className="w-px bg-slate-600 mx-1 hidden md:block"></div>
                            {/* Save/Load */}
                            <button 
                                onClick={() => fileInputRef.current?.click()}
                                className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white p-2 md:px-4 md:py-2 rounded-md text-sm font-medium transition-colors"
                                title="Load from File"
                            >
                                <FolderOpen size={16} /> <span className="hidden md:inline">Load</span>
                            </button>
                            <input 
                                ref={fileInputRef}
                                type="file"
                                accept=".json"
                                onChange={handleLoadFromFile}
                                className="hidden"
                            />
                            <button 
                                onClick={handleSaveToFile}
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white p-2 md:px-4 md:py-2 rounded-md text-sm font-medium transition-colors"
                                title="Save to File"
                            >
                                <Save size={16} /> <span className="hidden md:inline">Save</span>
                            </button>
                            <div className="w-px bg-slate-600 mx-1 hidden md:block"></div>
                            {/* Copy & Download */}
                            <button 
                                onClick={handleCopyToClipboard}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white p-2 md:px-4 md:py-2 rounded-md text-sm font-medium transition-colors"
                                title="Copy to Clipboard"
                            >
                                <Clipboard size={16} /> <span className="hidden md:inline">Copy</span>
                            </button>
                            <button 
                                onClick={handleDownloadJpg}
                                className="flex items-center gap-2 bg-purple-600 hover:bg-purple-500 text-white p-2 md:px-4 md:py-2 rounded-md text-sm font-medium transition-colors"
                                title="Download JPG"
                            >
                                <Download size={16} /> <span className="hidden md:inline">Download JPG</span>
                            </button>
                        </div>
                    </header>
                    )}

                    <div className="flex flex-1 overflow-hidden">
                        
                        {/* Left Sidebar */}
                        {!isFullScreen && (
                        <div className="w-1/3 min-w-[400px] bg-slate-800 border-r border-slate-700 flex flex-col">
                            <div className="flex border-b border-slate-700">
                                <button 
                                    onClick={() => setActiveTab('data')}
                                    className={`flex-1 py-3 text-sm font-medium flex items-center justify-center gap-2 ${activeTab === 'data' ? 'bg-slate-700 text-white border-b-2 border-blue-500' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <RefreshCw size={14} /> Data Input
                                </button>
                                <button 
                                    onClick={() => setActiveTab('css')}
                                    className={`flex-1 py-3 text-sm font-medium flex items-center justify-center gap-2 ${activeTab === 'css' ? 'bg-slate-700 text-white border-b-2 border-blue-500' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <Code size={14} /> CSS Styling
                                </button>
                            </div>

                            <div className="flex-1 p-4 relative">
                                {activeTab === 'data' ? (
                                    <div className="h-full flex flex-col gap-4">
                                        
                                        {/* Top Controls */}
                                        <div className="flex flex-col gap-3">
                                            {/* Title Input */}
                                            <div className="bg-slate-800 p-3 rounded-lg border border-slate-600">
                                                <div className="flex items-center gap-2 text-sm font-medium mb-2 text-blue-300">
                                                    <Type size={14} /> Chart Title
                                                </div>
                                                <input 
                                                    type="text" 
                                                    className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-sm focus:border-blue-500 outline-none text-slate-100"
                                                    placeholder="Enter chart title..."
                                                    value={chartTitle}
                                                    onChange={(e) => setChartTitle(e.target.value)}
                                                />
                                            </div>

                                            {/* Google Sheet Import */}
                                            <div className="bg-slate-800 p-3 rounded-lg border border-slate-600">
                                                <div className="flex items-center gap-2 text-sm font-medium mb-2 text-blue-300">
                                                    <LinkIcon size={14} /> Google Sheets Import
                                                </div>
                                                <div className="flex gap-2">
                                                    <input 
                                                        type="text" 
                                                        className="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-xs focus:border-blue-500 outline-none text-slate-100"
                                                        placeholder="Paste Google Sheet URL..."
                                                        value={sheetUrl}
                                                        onChange={(e) => setSheetUrl(e.target.value)}
                                                    />
                                                    <button 
                                                        onClick={handleSheetFetch}
                                                        disabled={isLoading}
                                                        className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-xs font-medium disabled:opacity-50"
                                                    >
                                                        {isLoading ? '...' : 'Fetch'}
                                                    </button>
                                                </div>
                                                {errorMsg && <div className="text-red-400 text-xs mt-2 leading-tight">{errorMsg}</div>}
                                            </div>
                                        </div>

                                        {/* Editor Toggle & Area */}
                                        <div className="flex-1 flex flex-col gap-2 min-h-0">
                                            <div className="flex justify-between items-center text-xs text-slate-400">
                                                <strong>Data Editor:</strong>
                                                <button 
                                                    onClick={() => setIsRawMode(!isRawMode)}
                                                    className="flex items-center gap-1 text-blue-400 hover:text-blue-300 transition-colors"
                                                >
                                                    {isRawMode ? <Table2 size={14}/> : <FileText size={14}/>}
                                                    {isRawMode ? "Switch to Grid" : "Switch to Raw CSV"}
                                                </button>
                                            </div>
                                            
                                            {isRawMode ? (
                                                <textarea 
                                                    className="flex-1 w-full bg-slate-900 border border-slate-700 rounded p-3 font-mono text-sm leading-relaxed focus:outline-none focus:border-blue-500 resize-none whitespace-pre overflow-auto text-slate-100"
                                                    value={rawData}
                                                    onChange={(e) => setRawDataWithHistory(e.target.value)}
                                                    placeholder="Paste CSV data here..."
                                                />
                                            ) : (
                                                <SpreadsheetEditor data={rawData} onUpdate={setRawDataWithHistory} onMoveRow={handleMoveRow} />
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    /* CSS Tab Content */
                                    <div className="h-full flex flex-col gap-2 overflow-auto">
                                        {/* Chart Colors */}
                                        <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 mb-2">
                                            <div className="flex items-center gap-2 text-sm font-medium mb-3 text-blue-300">
                                                <Palette size={14} /> Chart Colors
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="color" 
                                                        value={chartColors.background}
                                                        onChange={(e) => updateChartColor('background', e.target.value)}
                                                        className="w-8 h-8 rounded cursor-pointer shrink-0"
                                                    />
                                                    <span className="text-xs text-slate-300">Background</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="color" 
                                                        value={chartColors.title}
                                                        onChange={(e) => updateChartColor('title', e.target.value)}
                                                        className="w-8 h-8 rounded cursor-pointer shrink-0"
                                                    />
                                                    <span className="text-xs text-slate-300">Title</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="color" 
                                                        value={chartColors.legend}
                                                        onChange={(e) => updateChartColor('legend', e.target.value)}
                                                        className="w-8 h-8 rounded cursor-pointer shrink-0"
                                                    />
                                                    <span className="text-xs text-slate-300">Legend</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="color" 
                                                        value={chartColors.barValues}
                                                        onChange={(e) => updateChartColor('barValues', e.target.value)}
                                                        className="w-8 h-8 rounded cursor-pointer shrink-0"
                                                    />
                                                    <span className="text-xs text-slate-300">Bar Values</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="color" 
                                                        value={chartColors.categoryLabels}
                                                        onChange={(e) => updateChartColor('categoryLabels', e.target.value)}
                                                        className="w-8 h-8 rounded cursor-pointer shrink-0"
                                                    />
                                                    <span className="text-xs text-slate-300">Category Labels</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="color" 
                                                        value={chartColors.lastCategory}
                                                        onChange={(e) => updateChartColor('lastCategory', e.target.value)}
                                                        className="w-8 h-8 rounded cursor-pointer shrink-0"
                                                    />
                                                    <span className="text-xs text-slate-300">Last Category</span>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => setChartColors(DEFAULT_COLORS)}
                                                className="mt-3 text-xs text-blue-400 hover:text-blue-300"
                                            >
                                                Reset to defaults
                                            </button>
                                        </div>

                                        <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 mb-2">
                                            <div className="flex items-center gap-2 text-sm font-medium mb-2 text-blue-300">
                                                <Palette size={14} /> Theme Presets
                                            </div>
                                            <select 
                                                className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-sm focus:border-blue-500 outline-none text-white"
                                                value={selectedTheme}
                                                onChange={(e) => {
                                                    const themeName = e.target.value;
                                                    setSelectedTheme(themeName);
                                                    const selected = THEMES.find(t => t.name === themeName);
                                                    if(selected) setCssCode(selected.css);
                                                    // Apply theme colors to canvas
                                                    if(THEME_COLORS[themeName]) {
                                                        setChartColors(THEME_COLORS[themeName]);
                                                    }
                                                }}
                                            >
                                                {THEMES.map(t => (
                                                    <option key={t.name} value={t.name}>{t.name}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className="text-xs text-slate-400 mb-1">
                                            Manual CSS Override (legacy):
                                        </div>
                                        <textarea 
                                            className="flex-1 w-full bg-slate-900 border border-slate-700 rounded p-3 font-mono text-xs leading-relaxed text-blue-300 focus:outline-none focus:border-blue-500 resize-none"
                                            value={cssCode}
                                            onChange={(e) => setCssCode(e.target.value)}
                                            spellCheck="false"
                                        />
                                    </div>
                                )}
                            </div>
                        </div>
                        )}

                        {/* Right Area: Preview */}
                        <div className="flex-1 bg-slate-900 p-8 overflow-auto flex items-center justify-center relative">
                            <div className="absolute inset-0 opacity-5 pointer-events-none" 
                                style={{backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px'}}>
                            </div>

                            {isFullScreen && (
                                <button 
                                    onClick={() => setIsFullScreen(false)}
                                    className="absolute top-4 right-4 z-50 bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-full shadow-lg transition-colors"
                                    title="Exit Full Screen"
                                >
                                    <Minimize size={20} />
                                </button>
                            )}

                            {chartData ? (
                                <CanvasChart chartData={chartData} chartTitle={chartTitle} canvasRef={canvasRef} colors={chartColors} />
                    ) : (
                        <div className="text-slate-500">Invalid Data Format</div>
                    )}
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>